<!-- Last Update: 2025-09-22 03:05 - Fix missing resize and move handler functions (v0.15.1). -->
<!-- Last Update: 2025-09-22 03:02 - Implement desk rotation with accurate score recalculation (v0.15.0). -->
<!-- Last Update: 2025-09-22 02:43 - Improved intelligent naming for desk duplication (v0.14.0). -->
<!-- Last Update: 2025-09-22 02:39 - Implemented desk duplication with intelligent naming (v0.13.0). -->
<!-- Last Update: 2025-09-22 02:30 - Implement desk duplication with intelligent naming (v0.12.0). -->
<!-- Last Update: 2025-09-22 02:22 - Clean up unused code from previous copy/paste implementation (v0.12.1). -->
<!-- Last Update: 2025-09-22 02:15 - Replaced non-functional copy/paste with a 'duplicate' button placeholder (v0.11.0). -->
<!-- Last Update: 2025-09-22 01:45 - Add copy/paste functionality for desks with a custom context menu and intelligent naming (v0.11.0). -->
<!-- Last Update: 2025-09-22 01:37 - Fix and implement desk copy/paste. Add version display. -->
<!-- Last Update: 2025-09-22 01:20 - Add copy/paste functionality for desks with a custom context menu and intelligent naming. -->
<!-- Last Update: 2025-09-22 00:49 - Fix responsive modals with scrollbars & add version comment. -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Plan de Classe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for drag-and-drop and UI elements */
        .dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .drop-zone-highlight {
            outline: 2px dashed #3b82f6; /* blue-500 */
            background-color: rgba(59, 130, 246, 0.1);
        }
        .desk-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            cursor: nwse-resize;
            border-top-left-radius: 4px;
        }
        .classroom-area {
            background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #classroom-content {
            transform-origin: top left;
            width: 3000px; /* Large fixed size for the "world" */
            height: 2000px;
        }
        .seat-lock-icon {
            position: absolute;
            bottom: 2px;
            right: 2px;
            cursor: pointer;
            padding: 2px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 9999px; /* rounded-full */
            display: none; /* Caché par défaut */
            z-index: 10;
        }
        .drop-zone:hover .seat-lock-icon.unlocked {
            display: block; /* Montrer l'icône déverrouillée au survol */
        }
        .seat-lock-icon.locked {
            display: block; /* Toujours montrer l'icône verrouillée */
        }
        .action-btn {
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: white;
            border-radius: 9999px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .desk-container:hover .action-btn, .rule-container:hover .action-btn {
            display: flex;
        }
        .desk-rotate-handle {
            position: absolute;
            bottom: -6px;
            left: -6px;
            width: 16px;
            height: 16px;
            background-color: #6d28d9; /* violet-700 */
            border: 2px solid white;
            border-radius: 9999px;
            cursor: grabbing;
            display: none;
            z-index: 11;
        }
        .desk-container:hover .desk-rotate-handle {
            display: block;
        }
        .desk-delete-btn { top: -8px; right: -8px; }
        .desk-edit-btn { top: -8px; left: -8px; }
        .desk-duplicate-btn { top: -8px; left: 50%; transform: translateX(-50%); }

        .rule-delete-btn { top: 50%; right: 4px; transform: translateY(-50%); }
        .rule-edit-btn { top: 50%; right: 30px; transform: translateY(-50%); }

        .student-action-btn {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 9999px;
            display: none; /* Hide by default */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 11;
        }
        .student-container:hover .student-action-btn {
            display: flex; /* Show on hover */
        }
        .student-edit-btn { top: -7px; left: -7px; }
        .student-delete-btn { top: -7px; right: -7px; }

        .notification {
            animation: fadeInOut 4s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        .score-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 9999px;
            color: white;
            margin-left: 8px;
        }
        .desk-selected {
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .selection-rectangle {
            position: absolute;
            border: 1px solid #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
            z-index: 100;
            pointer-events: none;
        }
        #sidebar-wrapper.collapsed {
            width: 0 !important;
            max-width: 0 !important;
        }
        #sidebar-wrapper.collapsed #sidebar {
            padding-left: 0;
            padding-right: 0;
            visibility: hidden;
            overflow: hidden;
        }
        #sidebar-wrapper.collapsed #toggle-sidebar-icon {
            transform: rotate(180deg);
        }
        #toggle-gender-colors:checked + label {
            background-color: #3b82f6; /* blue-500 */
        }
        #toggle-gender-colors:checked + label .toggle-dot {
            transform: translateX(1.5rem); /* Move the dot to the right */
        }
        input[type="color"] {
          -webkit-appearance: none;
          border: none;
          width: 40px;
          height: 40px;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
          padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
          border: 1px solid #ccc;
          border-radius: 4px;
        }
        .student-selected {
            outline: 3px solid #2563eb; /* blue-600 */
            outline-offset: 2px;
            box-shadow: 0 0 12px rgba(37, 99, 235, 0.6);
            z-index: 20;
        }
        .student-neighbor {
            outline: 2px solid #93c5fd; /* blue-300 */
            outline-offset: 1px;
            box-shadow: 0 0 8px rgba(147, 197, 253, 0.5);
            z-index: 19;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Control Panel (Left Column) -->
    <div id="sidebar-wrapper" class="relative w-full md:w-1/3 md:max-w-sm h-auto md:h-screen flex-shrink-0 transition-all duration-300 ease-in-out">
        <aside id="sidebar" class="w-full h-full bg-white shadow-lg flex flex-col p-4 overflow-y-auto">
            <!-- Placement Rules -->
            <div class="space-y-4 flex-grow flex flex-col min-w-[300px]">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">Ajouter / Modifier une Règle</h3>
                    <form id="add-rule-form" class="space-y-2 text-sm">
                        <input type="hidden" id="editing-rule-index">
                        <div id="rule-student-container">
                            <label for="rule-student" class="block font-medium">Élève concerné :</label>
                            <select id="rule-student" class="w-full border rounded-md p-1 mt-1"></select>
                        </div>
                        <div>
                            <label for="rule-type" class="block font-medium">Règle :</label>
                            <select id="rule-type" class="w-full border rounded-md p-1 mt-1">
                                <option value="MUST_BE_NEAR">Doit être proche de</option>
                                <option value="FAR_FROM">Doit être éloigné de</option>
                                <option value="NEAR_BOARD">Doit être proche du tableau</option>
                                <option value="NEAR_TEACHER_DESK">Doit être proche de mon bureau</option>
                                <option value="ISOLATED">Doit être isolé</option>
                                <option value="MIX_GENDERS">Mélanger les Filles et les Garçons</option>
                            </select>
                        </div>
                        <div id="rule-target-container">
                            <label for="rule-target-student" class="block font-medium">Élève(s) cible(s) :</label>
                            <select id="rule-target-student" class="w-full border rounded-md p-1 mt-1 h-24" multiple></select>
                        </div>
                        <div id="rule-form-buttons" class="flex space-x-2 pt-1">
                            <button type="submit" id="rule-submit-btn" class="w-full bg-green-500 text-white py-1.5 rounded-md hover:bg-green-600">Ajouter Règle</button>
                        </div>
                    </form>
                </div>
                <div class="flex-grow flex flex-col">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">Règles Actives</h3>
                    <div id="rules-list" class="space-y-1 text-sm overflow-y-auto flex-grow">
                        <!-- Rules will be injected here -->
                    </div>
                </div>
            </div>
             <div class="text-xs text-gray-400 mt-4 text-left min-w-[300px]">Version <span id="version-display">0.15.1</span></div>
        </aside>
        <button id="toggle-sidebar-btn" class="hidden md:flex absolute top-1/2 -right-3 z-20 transform -translate-y-1/2 bg-white rounded-full w-6 h-6 items-center justify-center shadow-md border border-gray-200 hover:bg-gray-100 focus:outline-none">
            <svg id="toggle-sidebar-icon" class="w-4 h-4 text-gray-600 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
    </div>

    <!-- Classroom Area (Main Content) -->
    <main class="flex-grow h-full p-4 flex flex-col overflow-hidden">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
            <div class="flex flex-wrap justify-center gap-2">
                <button id="add-student-action-btn" class="text-sm bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Ajouter Élève</button>
                <button id="add-desk-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Ajouter Bureau</button>
                <button id="add-desk-double-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Ajouter Bureau Double</button>
                <button id="auto-place-btn" class="text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Placement Auto</button>
                <div class="flex items-center space-x-2 bg-gray-200 rounded-full p-1">
                    <label for="toggle-gender-colors" class="text-sm font-medium text-gray-700 cursor-pointer pr-2 pl-2">Couleurs par genre</label>
                    <input type="checkbox" id="toggle-gender-colors" class="hidden">
                    <label for="toggle-gender-colors" class="cursor-pointer relative w-12 h-6 bg-gray-300 rounded-full transition duration-300 ease-in-out">
                        <div class="toggle-dot absolute w-5 h-5 bg-white rounded-full shadow-md top-0.5 left-0.5 transform transition-transform duration-300 ease-in-out"></div>
                    </label>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 flex-shrink-0 my-2 md:my-0">
                 <div id="placement-score-display" class="text-lg font-bold text-gray-700"></div>
                 <button id="score-help-btn" class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center justify-center font-bold text-sm">?</button>
            </div>

            <div class="flex flex-wrap justify-center gap-2">
                <button id="export-btn" class="text-sm bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Enregistrer</button>
                <button id="import-btn" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Ouvrir</button>
                <button id="customization-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Personnalisation</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
             </div>
        </div>
        <div id="classroom-area" class="w-full h-full bg-white rounded-xl shadow-inner relative overflow-auto classroom-area flex-grow">
            <div id="classroom-content">
                    <!-- Desks and Board will be injected here -->
            </div>
            <div id="zoom-controls" class="absolute bottom-4 right-4 bg-white/80 backdrop-blur-sm rounded-lg shadow-md flex items-center p-1 space-x-1">
                 <button id="zoom-out-btn" class="w-8 h-8 font-bold text-lg rounded-md hover:bg-gray-200">-</button>
                 <span id="zoom-display" class="text-sm font-semibold w-12 text-center">100%</span>
                 <button id="zoom-in-btn" class="w-8 h-8 font-bold text-lg rounded-md hover:bg-gray-200">+</button>
                 <button id="zoom-reset-btn" class="w-8 h-8 rounded-md hover:bg-gray-200">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm11 11a1 1 0 10-2 0v-1a1 1 0 10-2 0v1a1 1 0 102 0V9a1 1 0 102 0v4zM8 9a1 1 0 011-1h1a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                     </svg>
                 </button>
            </div>
        </div>
    </main>
    
    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg shadow-xl relative mx-4 flex flex-col max-h-[90vh]">
             <div class="flex-shrink-0">
                  <button id="close-help-btn" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                  <h2 class="text-xl font-bold mb-4 border-b pb-2">À Propos du Score de Placement</h2>
             </div>
            <div class="space-y-4 text-gray-700 mt-4 overflow-y-auto">
                <div>
                    <h3 class="font-semibold text-gray-800">À quoi sert le score ?</h3>
                    <p class="text-sm">Le score est un indicateur qui vous aide à évaluer la qualité d'un plan de classe. Son objectif est de mesurer à quel point le placement actuel des élèves respecte l'ensemble des règles que vous avez définies. Un score élevé signifie un meilleur respect des règles.</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800">À quoi correspond le pourcentage ?</h3>
                    <p class="text-sm">Le score global affiché est la <strong>moyenne des pourcentages de respect de chaque règle active</strong>.</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800">Comment est calculé le score de chaque règle ?</h3>
                    <ul class="list-disc list-inside space-y-2 pl-2 text-sm">
                        <li>
                            <strong>Doit être proche du tableau :</strong> Le score est calculé uniquement en fonction de la <strong>distance verticale</strong> entre la place de l'élève et le tableau. Un élève sur une rangée de bureaux la plus proche obtient 100%. Un élève sur la rangée la plus éloignée obtient 0%. Les autres obtiennent un score proportionnel à leur distance verticale.
                        </li>
                        <li>
                            <strong>Doit être proche de mon bureau :</strong> Le score est calculé en fonction de la distance directe entre la place de l'élève et le bureau du professeur. Un élève sur la place la plus proche obtient 100%, le plus éloigné 0%.
                        </li>
                        <li>
                            <strong>Doit être isolé :</strong> Le score est de <strong>0%</strong> si l'élève partage son bureau. S'il est seul, le score est de 100% si son voisin le plus proche est le plus loin possible, et diminue à mesure que son voisin se rapproche.
                        </li>
                        <li>
                            <strong>Mélanger les Filles et les Garçons :</strong> Le score compare la distance moyenne entre élèves de même genre à la distance moyenne entre élèves de genres différents. Un score de 100% indique un mélange parfait. Un score faible indique que les élèves de même genre sont regroupés.
                        </li>
                        <li>
                            <strong>Doit être proche de / éloigné de :</strong> Si une règle concerne plusieurs élèves cibles, le score est la <strong>moyenne des scores</strong> calculés pour chaque élève cible individuellement.
                        </li>
                        <li>
                            <strong>Doit être proche de :</strong> Le score pour une paire d'élèves est de 100% s'ils sont sur le même bureau. Sinon, il diminue proportionnellement à la distance qui les sépare. Une paire d'élèves aux deux places les plus éloignées possibles obtient 0%.
                        </li>
                        <li>
                            <strong>Doit être éloigné de :</strong> C'est l'inverse de la règle précédente. Une paire d'élèves aux deux places les plus éloignées possible obtient 100%. S'ils sont sur le même bureau, le score est de 0%.
                        </li>
                         <li>
                            <strong>Élève non placé :</strong> Si l'élève concerné par une règle n'est pas placé, la règle obtient <strong>0%</strong>. Si un des élèves cibles n'est pas placé, seule la partie de la règle le concernant obtient 0%, ce qui est ensuite moyenné avec les autres.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal (hidden by default) -->
    <div id="student-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl mx-4">
            <h2 id="modal-title" class="text-xl font-bold mb-4">Ajouter un Élève</h2>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="mb-4">
                    <label for="student-firstName" class="block text-sm font-medium text-gray-700">Prénom</label>
                    <input type="text" id="student-firstName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                </div>
                <div class="mb-4">
                    <label for="student-lastName" class="block text-sm font-medium text-gray-700">Nom</label>
                    <input type="text" id="student-lastName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                </div>
                <div class="mb-4">
                    <label for="student-gender" class="block text-sm font-medium text-gray-700">Genre</label>
                    <select id="student-gender" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <option value=""></option>
                        <option value="Fille">Fille</option>
                        <option value="Garçon">Garçon</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-student-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Desk Settings Modal (hidden by default) -->
    <div id="desk-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl mx-4">
            <h2 class="text-xl font-bold mb-4">Réglages du Bureau</h2>
            <form id="desk-settings-form">
                <input type="hidden" id="desk-id-settings">
                <div class="mb-4">
                    <label for="desk-name" class="block text-sm font-medium text-gray-700">Nom du bureau (laisser vide pour cacher)</label>
                    <input type="text" id="desk-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div class="mb-4" id="desk-capacity-container">
                    <label for="desk-capacity" class="block text-sm font-medium text-gray-700">Nombre de places</label>
                    <select id="desk-capacity" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <option value="1">1 place</option>
                        <option value="2">2 places</option>
                    </select>
                </div>
                 <div class="mb-4" id="desk-distance-container">
                    <label class="block text-sm font-medium text-gray-700">Distance des places au tableau</label>
                    <p id="desk-distance-info" class="mt-1 text-gray-500 text-sm">Calcul...</p>
                </div>
                <div class="flex justify-end items-center">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">OK</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl mx-4">
            <h2 class="text-lg font-bold mb-4">Confirmation requise</h2>
            <p id="confirmation-message" class="mb-6 text-gray-700">Voulez-vous vraiment effectuer cette action ?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Annuler</button>
                <button id="confirm-ok-btn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Confirmer</button>
            </div>
        </div>
    </div>
    
    <!-- Customization Modal -->
    <div id="customization-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Personnalisation</h2>
                <button id="close-customization-modal-btn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="customization-form">
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">Voisinage</h3>
                        <div class="flex items-center justify-between mt-4">
                            <label for="neighbor-count" class="block text-sm font-medium text-gray-700">Nombre de voisins à afficher</label>
                            <input type="number" id="neighbor-count" class="w-20 border border-gray-300 rounded-md shadow-sm py-1 px-2 text-center">
                        </div>
                    </div>
                    <div>
                         <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">Couleurs par genre</h3>
                        <div class="space-y-3 mt-4">
                            <div class="flex items-center justify-between">
                                <label for="color-boy" class="block text-sm font-medium text-gray-700">Garçon</label>
                                <input type="color" id="color-boy" class="w-10 h-10 border-none cursor-pointer rounded-md">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="color-girl" class="block text-sm font-medium text-gray-700">Fille</label>
                                <input type="color" id="color-girl" class="w-10 h-10 border-none cursor-pointer rounded-md">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="color-other" class="block text-sm font-medium text-gray-700">Autre</label>
                                <input type="color" id="color-other" class="w-10 h-10 border-none cursor-pointer rounded-md">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="color-unspecified" class="block text-sm font-medium text-gray-700">Non spécifié</label>
                                <input type="color" id="color-unspecified" class="w-10 h-10 border-none cursor-pointer rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="reset-colors-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Réinitialiser</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let state = {
        students: [],
        desks: [],
        teacherDesk: null,
        board: null,
        placements: {}, // { deskId: [studentId1, studentId2 | null] }
        rules: [],
        lockedStudents: [], // [studentId1, studentId2]
        settings: {
            showGenderColors: true,
            genderColors: {
                'Garçon': '#3b82f6',
                'Fille': '#ef4444',
                'Autre': '#eab308',
                '': '#fde047'
            },
            numberOfNeighbors: 4
        }
    };
    let seatDistancesCache = new Map();
    let teacherDeskDistancesCache = new Map();
    let interSeatDistancesCache = new Map();
    let ruleScores = new Map();
    let zoomLevel = 1.0;
    let selectedDeskIds = new Set();
    let selectedStudentId = null;
    let neighborCache = new Map();
    
    // --- DOM ELEMENTS ---
    const classroomArea = document.getElementById('classroom-area');
    const classroomContent = document.getElementById('classroom-content');
    const rulesList = document.getElementById('rules-list');
    const placementScoreDisplay = document.getElementById('placement-score-display');
    const sidebarWrapper = document.getElementById('sidebar-wrapper');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');

    // Modals
    const studentModal = document.getElementById('student-modal');
    const studentForm = document.getElementById('student-form');
    const deskSettingsModal = document.getElementById('desk-settings-modal');
    const deskSettingsForm = document.getElementById('desk-settings-form');
    const confirmationModal = document.getElementById('confirmation-modal');
    const helpModal = document.getElementById('help-modal');
    const customizationModal = document.getElementById('customization-modal');
    
    // Buttons
    const addStudentActionBtn = document.getElementById('add-student-action-btn');
    const cancelStudentBtn = document.getElementById('cancel-student-btn');
    const addDeskBtn = document.getElementById('add-desk-btn');
    const addDeskDoubleBtn = document.getElementById('add-desk-double-btn');
    const autoPlaceBtn = document.getElementById('auto-place-btn');
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFileInput = document.getElementById('import-file-input');
    const scoreHelpBtn = document.getElementById('score-help-btn');
    const closeHelpBtn = document.getElementById('close-help-btn');
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const zoomResetBtn = document.getElementById('zoom-reset-btn');
    const zoomDisplay = document.getElementById('zoom-display');
    const customizationBtn = document.getElementById('customization-btn');
    const closeCustomizationModalBtn = document.getElementById('close-customization-modal-btn');
    const resetColorsBtn = document.getElementById('reset-colors-btn');
    const toggleGenderColors = document.getElementById('toggle-gender-colors');
    
    // Forms
    const addRuleForm = document.getElementById('add-rule-form');
    const ruleTypeSelect = document.getElementById('rule-type');
    const ruleStudentContainer = document.getElementById('rule-student-container');
    const ruleTargetContainer = document.getElementById('rule-target-container');
    const customizationForm = document.getElementById('customization-form');

    // --- DATA PERSISTENCE ---
    function saveState() {
        localStorage.setItem('classroomPlanState', JSON.stringify(state));
        console.log("Données sauvegardées dans le localStorage:", JSON.parse(JSON.stringify(state)));
    }

    function migrateState(stateToMigrate) {
        if (stateToMigrate && stateToMigrate.rules) {
            stateToMigrate.rules.forEach(rule => {
                // Check for old format (single targetStudentId) and convert it
                if (rule.targetStudentId && !rule.targetStudentIds) {
                    rule.targetStudentIds = [rule.targetStudentId];
                }
                delete rule.targetStudentId; // Remove old property

                // Ensure targetStudentIds is always an array, even if empty
                if (!rule.targetStudentIds) {
                    rule.targetStudentIds = [];
                }
            });
        }
        return stateToMigrate;
    }

    // --- UTILITY FUNCTIONS ---
    const findStudent = (id) => state.students.find(s => s.id === id);
    const findDesk = (id) => state.desks.find(d => d.id === id);
    const getStudentFullName = (id) => {
        const student = findStudent(id);
        return student ? `${student.firstName} ${student.lastName}` : 'Inconnu';
    };

    function deleteStudent(studentId) {
        state.students = state.students.filter(s => s.id !== studentId);
        for (const deskId in state.placements) {
            state.placements[deskId] = state.placements[deskId].map(sId => sId === studentId ? null : sId);
        }
        state.rules = state.rules.filter(r => r.studentId !== studentId && !(r.targetStudentIds && r.targetStudentIds.includes(studentId)));
        state.lockedStudents = state.lockedStudents.filter(id => id !== studentId);
        saveState();
        render();
        updateStudentsInForms();
        updateAllDistances();
    }
    
    // --- RENDER FUNCTIONS ---
    function render() {
        renderClassroom();
        renderRules();
    }

    function updateStudentsInForms() {
        renderRuleForm();
    }
    
    function getTextColorForBg(bgColor) {
        if (!bgColor) return '#1f2937'; // default dark text
        try {
            const r = parseInt(bgColor.substr(1, 2), 16);
            const g = parseInt(bgColor.substr(3, 2), 16);
            const b = parseInt(bgColor.substr(5, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 125 ? '#1f2937' : 'white';
        } catch (e) {
            return '#1f2937';
        }
    }


    function renderClassroom() {
        classroomContent.innerHTML = '';
        const neighbors = selectedStudentId ? neighborCache.get(selectedStudentId) || [] : [];

        // Render student desks
        state.desks.forEach(desk => {
            const deskEl = document.createElement('div');
            deskEl.id = desk.id;
            deskEl.className = 'absolute bg-yellow-600 rounded-md shadow-lg flex flex-col p-1 desk-container';
            deskEl.style.left = `${desk.x}px`;
            deskEl.style.top = `${desk.y}px`;
            deskEl.style.width = `${desk.width}px`;
            deskEl.style.height = `${desk.height}px`;
            deskEl.style.transform = `rotate(${desk.rotation || 0}deg)`;
            deskEl.style.cursor = 'move';

            if (selectedDeskIds.has(desk.id)) {
                deskEl.classList.add('desk-selected');
            }

            deskEl.addEventListener('mousedown', handleDeskMoveStart);
            deskEl.addEventListener('dblclick', () => openDeskSettings(desk.id));

            if (desk.name && desk.name.trim() !== '') {
                const nameEl = document.createElement('div');
                nameEl.className = 'text-center text-xs text-white font-semibold';
                nameEl.textContent = desk.name;
                deskEl.appendChild(nameEl);
            }
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'desk-resize-handle';
            resizeHandle.addEventListener('mousedown', handleDeskResizeStart);
            deskEl.appendChild(resizeHandle);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn desk-delete-btn';
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showConfirmation(`Voulez-vous vraiment supprimer le bureau "${desk.name || 'sans nom'}" ?`, () => {
                    state.desks = state.desks.filter(d => d.id !== desk.id);
                    delete state.placements[desk.id];
                    selectedDeskIds.delete(desk.id);
                    saveState();
                    render();
                    updateAllDistances();
                });
            });
            deskEl.appendChild(deleteBtn);
            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn desk-edit-btn';
            editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openDeskSettings(desk.id);
            });
            deskEl.appendChild(editBtn);

            const duplicateBtn = document.createElement('button');
            duplicateBtn.className = 'action-btn desk-duplicate-btn';
            duplicateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
            duplicateBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                duplicateDesk(desk.id);
            });
            deskEl.appendChild(duplicateBtn);

            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'desk-rotate-handle';
            rotateHandle.addEventListener('mousedown', (e) => handleDeskRotateStart(e, desk.id));
            deskEl.appendChild(rotateHandle);

            const seatsContainer = document.createElement('div');
            const hasName = desk.name && desk.name.trim() !== '';
            const marginTopClass = hasName ? 'mt-1' : 'mt-4';
            seatsContainer.className = `w-full h-full flex items-center justify-around flex-grow ${marginTopClass}`;
            for (let i = 0; i < desk.capacity; i++) {
                const seatEl = document.createElement('div');
                seatEl.className = 'w-full h-full rounded-md m-1 flex items-center justify-center text-xs font-semibold drop-zone relative student-container';
                seatEl.dataset.deskId = desk.id;
                seatEl.dataset.seatIndex = i;
                seatEl.addEventListener('dragover', handleDragOver);
                seatEl.addEventListener('dragleave', handleDragLeave);
                seatEl.addEventListener('drop', handleDrop);
                const placedStudentId = state.placements[desk.id] ? state.placements[desk.id][i] : null;

                if (placedStudentId) {
                    const student = findStudent(placedStudentId);
                    seatEl.dataset.studentId = placedStudentId;
                    seatEl.innerHTML = `<button class="student-action-btn student-edit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button><button class="student-action-btn student-delete-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button><span>${student.firstName} ${student.lastName.charAt(0)}.</span>`;
                    seatEl.querySelector('.student-edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openStudentModal(placedStudentId); });
                    seatEl.querySelector('.student-delete-btn').addEventListener('click', (e) => { e.stopPropagation(); showConfirmation(`Voulez-vous vraiment supprimer l'élève ${getStudentFullName(placedStudentId)} ?`, () => { deleteStudent(placedStudentId); }); });
                    
                    seatEl.classList.add('cursor-grab');
                    if (state.settings.showGenderColors) {
                        const gender = student.gender || '';
                        const bgColor = state.settings.genderColors[gender];
                        seatEl.style.backgroundColor = bgColor;
                        seatEl.style.color = getTextColorForBg(bgColor);
                    } else {
                        seatEl.style.backgroundColor = '#16a34a'; // green-600
                        seatEl.style.color = 'white';
                    }

                    seatEl.draggable = true;
                    seatEl.addEventListener('dragstart', handleDragStart);
                    const lockBtn = document.createElement('button');
                    lockBtn.className = 'seat-lock-icon';
                    const isLocked = state.lockedStudents.includes(placedStudentId);
                    if (isLocked) {
                        lockBtn.classList.add('locked');
                        lockBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-gray-700" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/></svg>`;
                    } else {
                        lockBtn.classList.add('unlocked');
                        lockBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-700"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>`;
                    }
                    lockBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleStudentLock(placedStudentId); });
                    seatEl.appendChild(lockBtn);

                    if (placedStudentId === selectedStudentId) seatEl.classList.add('student-selected');
                    if (neighbors.includes(placedStudentId)) seatEl.classList.add('student-neighbor');
                } else {
                    seatEl.textContent = 'Libre';
                    seatEl.style.backgroundColor = '#9a3412'; // yellow-800
                    seatEl.style.color = 'white';
                }
                seatsContainer.appendChild(seatEl);
            }
            deskEl.appendChild(seatsContainer);
            classroomContent.appendChild(deskEl);
        });

        if (state.board) {
            const boardEl = document.createElement('div');
            boardEl.id = 'board';
            boardEl.className = 'absolute bg-gray-700 rounded-md shadow-lg flex items-center justify-center text-white font-bold';
            boardEl.style.left = `${state.board.x}px`;
            boardEl.style.top = `${state.board.y}px`;
            boardEl.style.width = `${state.board.width}px`;
            boardEl.style.height = `${state.board.height}px`;
            boardEl.style.cursor = 'move';
            boardEl.textContent = 'TABLEAU';
            boardEl.addEventListener('mousedown', handleBoardMoveStart);
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'desk-resize-handle';
            resizeHandle.addEventListener('mousedown', handleBoardResizeStart);
            boardEl.appendChild(resizeHandle);
            
            classroomContent.appendChild(boardEl);
        }

        if (state.teacherDesk) {
            const td = state.teacherDesk;
            const deskEl = document.createElement('div');
            deskEl.id = td.id;
            deskEl.className = 'absolute bg-yellow-800 rounded-md shadow-lg flex items-center justify-center p-1 desk-container';
            deskEl.style.left = `${td.x}px`;
            deskEl.style.top = `${td.y}px`;
            deskEl.style.width = `${td.width}px`;
            deskEl.style.height = `${td.height}px`;
            deskEl.style.transform = `rotate(${td.rotation || 0}deg)`;
            deskEl.style.cursor = 'move';

            deskEl.addEventListener('mousedown', handleTeacherDeskMoveStart);
            deskEl.addEventListener('dblclick', () => openDeskSettings(td.id, true));

            const nameEl = document.createElement('div');
            nameEl.className = 'text-center text-sm text-white font-semibold';
            nameEl.textContent = td.name;
            deskEl.appendChild(nameEl);

            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'desk-resize-handle';
            resizeHandle.addEventListener('mousedown', handleTeacherDeskResizeStart);
            deskEl.appendChild(resizeHandle);
            
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'desk-rotate-handle';
            rotateHandle.addEventListener('mousedown', handleTeacherDeskRotateStart);
            deskEl.appendChild(rotateHandle);

            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn desk-edit-btn';
            editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openDeskSettings(td.id, true);
            });
            deskEl.appendChild(editBtn);

            classroomContent.appendChild(deskEl);
        }

        const placedStudentIds = Object.values(state.placements).flat().filter(id => id);
        const unplacedStudents = state.students.filter(s => !placedStudentIds.includes(s.id));
        const boardBottom = state.board ? state.board.y + state.board.height : 20;
        const areaWidth = classroomArea.offsetWidth;
        const chipWidth = 120;
        const chipHeight = 30;
        const horizontalMargin = 10;
        const verticalMargin = 10;
        let currentX = horizontalMargin;
        let currentY = boardBottom + verticalMargin;
        unplacedStudents.forEach(student => {
            if (currentX + chipWidth + horizontalMargin > areaWidth) {
                currentX = horizontalMargin;
                currentY += chipHeight + verticalMargin;
            }
            const studentChip = document.createElement('div');
            studentChip.id = `unplaced-${student.id}`;
            studentChip.dataset.studentId = student.id;
            studentChip.draggable = true;
            studentChip.className = 'absolute p-1 px-2 rounded-full text-sm cursor-grab flex items-center justify-center shadow student-container';
            studentChip.style.left = `${currentX}px`;
            studentChip.style.top = `${currentY}px`;
            studentChip.style.width = `${chipWidth}px`;
            studentChip.style.height = `${chipHeight}px`;
            
            if (state.settings.showGenderColors) {
                const gender = student.gender || '';
                const bgColor = state.settings.genderColors[gender];
                studentChip.style.backgroundColor = bgColor;
                studentChip.style.color = getTextColorForBg(bgColor);
            } else {
                studentChip.classList.add('bg-blue-200', 'text-blue-800');
            }

            if (student.id === selectedStudentId) studentChip.classList.add('student-selected');
            if (neighbors.includes(student.id)) studentChip.classList.add('student-neighbor');
            
            studentChip.innerHTML = `<button class="student-action-btn student-edit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button><button class="student-action-btn student-delete-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button><span>${student.firstName} ${student.lastName.charAt(0)}.</span>`;
            studentChip.querySelector('.student-edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openStudentModal(student.id); });
            studentChip.querySelector('.student-delete-btn').addEventListener('click', (e) => { e.stopPropagation(); showConfirmation(`Voulez-vous vraiment supprimer l'élève ${getStudentFullName(student.id)} ?`, () => { deleteStudent(student.id); }); });
            studentChip.addEventListener('dragstart', handleDragStart);
            studentChip.addEventListener('dblclick', () => openStudentModal(student.id));
            classroomContent.appendChild(studentChip);
            currentX += chipWidth + horizontalMargin;
        });
    }

    function getScoreColor(score) {
        if (score == null) return 'background-color: #e5e7eb; color: #4b5563;'; // gray-200, gray-600
        const hue = score * 1.2; // 0 -> 0 (red), 100 -> 120 (green)
        return `background-color: hsl(${hue}, 80%, 45%); color: white;`;
    }
    
    function renderRules() {
        rulesList.innerHTML = '';
        state.rules.forEach((rule, index) => {
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'flex justify-between items-center p-2 bg-white rounded-md relative rule-container';
            let ruleText = '';
            
            if (rule.type === 'MIX_GENDERS') {
                ruleText = 'Mélanger les Filles et les Garçons';
            } else {
                const studentName = getStudentFullName(rule.studentId);
                let targetText = '';
                if (rule.targetStudentIds && rule.targetStudentIds.length > 0) {
                     targetText = `<b>${rule.targetStudentIds.map(getStudentFullName).join(', ')}</b>`;
                }

                switch (rule.type) {
                    case 'MUST_BE_NEAR': ruleText = `<b>${studentName}</b> doit être proche de ${targetText}`; break;
                    case 'FAR_FROM': ruleText = `<b>${studentName}</b> doit être éloigné de ${targetText}`; break;
                    case 'NEAR_BOARD': ruleText = `<b>${studentName}</b> doit être proche du tableau`; break;
                    case 'NEAR_TEACHER_DESK': ruleText = `<b>${studentName}</b> doit être proche de mon bureau`; break;
                    case 'ISOLATED': ruleText = `<b>${studentName}</b> doit être isolé`; break;
                }
            }
            
            const score = ruleScores.get(index);
            const scoreDisplay = score != null ? `${score.toFixed(0)}%` : 'N/A';

            ruleDiv.innerHTML = `
                <span class="flex-grow pr-12">${ruleText}</span>
                <span class="score-badge" style="${getScoreColor(score)}">${scoreDisplay}</span>
                <button data-index="${index}" class="action-btn rule-edit-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                </button>
                <button data-index="${index}" class="action-btn rule-delete-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                </button>
            `;
            rulesList.appendChild(ruleDiv);
        });
    }

    function renderRuleForm() {
        const studentSelect = document.getElementById('rule-student');
        const targetStudentSelect = document.getElementById('rule-target-student');
        studentSelect.innerHTML = '<option value="">-- Choisir un élève --</option>';
        targetStudentSelect.innerHTML = '';
        state.students.forEach(s => {
            studentSelect.innerHTML += `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`;
            targetStudentSelect.innerHTML += `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`;
        });
    }

    // --- MODAL & FORM HANDLING ---
    function openStudentModal(studentId = null) {
        studentForm.reset();
        document.getElementById('student-id').value = '';
        if (studentId) {
            const student = findStudent(studentId);
            document.getElementById('modal-title').textContent = 'Modifier un Élève';
            document.getElementById('student-id').value = student.id;
            document.getElementById('student-firstName').value = student.firstName;
            document.getElementById('student-lastName').value = student.lastName;
            document.getElementById('student-gender').value = student.gender || '';
        } else {
            document.getElementById('modal-title').textContent = 'Ajouter un Élève';
        }
        studentModal.classList.remove('hidden');
    }

    function closeStudentModal() {
        studentModal.classList.add('hidden');
    }
    
    studentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('student-id').value;
        const studentData = { 
            firstName: document.getElementById('student-firstName').value, 
            lastName: document.getElementById('student-lastName').value,
            gender: document.getElementById('student-gender').value,
        };
        let newStudentId;
        if (id) {
            const student = findStudent(id);
            Object.assign(student, studentData);
        } else {
            studentData.id = crypto.randomUUID();
            newStudentId = studentData.id;
            state.students.push(studentData);
        }
        if (newStudentId) {
            const sortedDesks = [...state.desks].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            for (const desk of sortedDesks) {
                if (!state.placements[desk.id]) {
                     state.placements[desk.id] = Array(desk.capacity).fill(null);
                }
                const emptySeatIndex = state.placements[desk.id].indexOf(null);
                if (emptySeatIndex !== -1) {
                    state.placements[desk.id][emptySeatIndex] = newStudentId;
                    break;
                }
            }
        }
        saveState();
        render();
        updateStudentsInForms();
        calculateAndStoreAllRuleScores();
        closeStudentModal();
    });

    addStudentActionBtn.addEventListener('click', () => openStudentModal());
    cancelStudentBtn.addEventListener('click', closeStudentModal);
    scoreHelpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
    closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
    helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) {
            helpModal.classList.add('hidden');
        }
    });

    function openDeskSettings(deskId, isTeacher = false) {
        const desk = isTeacher ? state.teacherDesk : findDesk(deskId);
        document.getElementById('desk-id-settings').value = desk.id;
        document.getElementById('desk-name').value = desk.name;
        
        const capacityContainer = document.getElementById('desk-capacity-container');
        const distanceContainer = document.getElementById('desk-distance-container');

        if (isTeacher) {
            capacityContainer.style.display = 'none';
            distanceContainer.style.display = 'none';
        } else {
            capacityContainer.style.display = 'block';
            distanceContainer.style.display = 'block';
            document.getElementById('desk-capacity').value = desk.capacity;

            let distanceText = 'N/A';
            if (seatDistancesCache.size > 0) {
                const distances = [];
                for (let i = 0; i < desk.capacity; i++) {
                    const seatId = `${desk.id}-${i}`;
                    if (seatDistancesCache.has(seatId)) {
                        distances.push(seatDistancesCache.get(seatId).toFixed(0));
                    }
                }
                if (distances.length > 0) {
                    distanceText = `${distances.join('px, ')}px`;
                }
            }
            document.getElementById('desk-distance-info').textContent = distanceText;
        }

        deskSettingsModal.classList.remove('hidden');
    }

    deskSettingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const deskId = document.getElementById('desk-id-settings').value;
        const name = document.getElementById('desk-name').value;

        if (deskId === 'teacher-desk') {
            state.teacherDesk.name = name;
        } else {
            const capacity = parseInt(document.getElementById('desk-capacity').value, 10);
            const desk = findDesk(deskId);
            desk.name = name;
            if (desk.capacity !== capacity) {
                if (capacity < desk.capacity && state.placements[deskId]) {
                    state.placements[deskId] = state.placements[deskId].slice(0, capacity);
                }
                desk.capacity = capacity;
            }
        }
        saveState();
        render();
        updateAllDistances();
        deskSettingsModal.classList.add('hidden');
    });

    deskSettingsModal.addEventListener('click', (e) => {
        if (e.target === deskSettingsModal) {
            deskSettingsModal.classList.add('hidden');
        }
    });

    // --- Confirmation Modal Logic ---
    let confirmCallback = null;
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmationMessage = document.getElementById('confirmation-message');

    function showConfirmation(message, callback) {
        confirmationMessage.textContent = message;
        confirmCallback = callback;
        confirmationModal.classList.remove('hidden');
    }

    function hideConfirmation() {
        confirmationModal.classList.add('hidden');
        confirmCallback = null;
    }

    confirmOkBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        hideConfirmation();
    });

    confirmCancelBtn.addEventListener('click', hideConfirmation);
    confirmationModal.addEventListener('click', (e) => {
        if (e.target === confirmationModal) {
            hideConfirmation();
        }
    });

    // --- DRAG & DROP ---
    let draggedStudentId = null;

    function handleDragStart(e) {
        if (e.target.classList.contains('student-action-btn')) { e.preventDefault(); return; }
        draggedStudentId = e.target.closest('[data-student-id]').dataset.studentId;
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => e.target.closest('[data-student-id]').classList.add('dragging'), 0);
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drop-zone-highlight');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drop-zone-highlight');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drop-zone-highlight');
        const targetDeskId = e.currentTarget.dataset.deskId;
        const targetSeatIndex = parseInt(e.currentTarget.dataset.seatIndex, 10);
        let sourceDeskId = null;
        for (const deskId in state.placements) {
            const seatIndex = state.placements[deskId].indexOf(draggedStudentId);
            if (seatIndex > -1) {
                sourceDeskId = deskId;
                state.placements[deskId][seatIndex] = null;
                break;
            }
        }
        if (!state.placements[targetDeskId]) {
            const desk = findDesk(targetDeskId);
            state.placements[targetDeskId] = Array(desk.capacity).fill(null);
        }
        const studentInTargetSeat = state.placements[targetDeskId][targetSeatIndex];
        if (studentInTargetSeat && sourceDeskId) {
            const oldSeatIndex = state.placements[sourceDeskId].indexOf(null);
            state.placements[sourceDeskId][oldSeatIndex] = studentInTargetSeat;
        }
        state.placements[targetDeskId][targetSeatIndex] = draggedStudentId;
        draggedStudentId = null;
        document.querySelector('.dragging')?.classList.remove('dragging');
        
        updateNeighborCache();
        
        saveState();
        render();
        calculateAndStoreAllRuleScores();
    }
    
    classroomArea.addEventListener('dragover', handleDragOver);
    classroomArea.addEventListener('dragleave', handleDragLeave);
    classroomArea.addEventListener('drop', (e) => {
        if (e.target !== classroomContent && e.target !== classroomArea) { e.currentTarget.classList.remove('drop-zone-highlight'); return; }
        e.preventDefault();
        classroomArea.classList.remove('drop-zone-highlight');
        if (!draggedStudentId) return;
        for (const deskId in state.placements) {
            const seatIndex = state.placements[deskId].indexOf(draggedStudentId);
            if (seatIndex > -1) {
                state.placements[deskId][seatIndex] = null;
                break;
            }
        }
        draggedStudentId = null;
        document.querySelector('.dragging')?.classList.remove('dragging');
        
        updateNeighborCache();
        
        saveState();
        render();
        calculateAndStoreAllRuleScores();
    });

    // --- Element Moving/Resizing ---
    function updateSelectionVisuals() {
        document.querySelectorAll('.desk-container').forEach(el => {
            el.classList.toggle('desk-selected', selectedDeskIds.has(el.id));
        });
    }

    function handleDeskMoveStart(e) {
        if(e.target.closest('.action-btn') || e.target.classList.contains('desk-resize-handle') || e.target.closest('[data-student-id]')) return;

        const clickedDeskEl = e.currentTarget;
        const clickedDeskId = clickedDeskEl.id;

        // --- Selection Logic ---
        if (e.ctrlKey) {
            if (selectedDeskIds.has(clickedDeskId)) {
                selectedDeskIds.delete(clickedDeskId);
            } else {
                selectedDeskIds.add(clickedDeskId);
            }
        } else {
            if (!selectedDeskIds.has(clickedDeskId)) {
                selectedDeskIds.clear();
                selectedDeskIds.add(clickedDeskId);
            }
        }
        updateSelectionVisuals();
        e.preventDefault();
        
        // --- Dragging Logic ---
        const startX = e.clientX;
        const startY = e.clientY;
        
        const dragTargets = [];
        selectedDeskIds.forEach(deskId => {
            const desk = findDesk(deskId);
            const deskEl = document.getElementById(deskId);
            if (desk && deskEl) {
                dragTargets.push({ desk, deskEl, initialX: desk.x, initialY: desk.y });
            }
        });

        if (dragTargets.length === 0) return;

        function onMouseMove(moveEvent) {
            const dx = (moveEvent.clientX - startX) / zoomLevel;
            const dy = (moveEvent.clientY - startY) / zoomLevel;
            
            dragTargets.forEach(target => {
                target.desk.x = target.initialX + dx;
                target.desk.y = target.initialY + dy;
                target.deskEl.style.left = `${target.desk.x}px`;
                target.deskEl.style.top = `${target.desk.y}px`;
            });
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function handleDeskResizeStart(e) {
        e.preventDefault();
        e.stopPropagation();
        const deskEl = e.target.parentElement;
        const desk = findDesk(deskEl.id);
        const startX = e.clientX;
        const startY = e.clientY;
        const initialWidth = desk.width;
        const initialHeight = desk.height;
        function onMouseMove(e) {
            const dx = (e.clientX - startX) / zoomLevel;
            const dy = (e.clientY - startY) / zoomLevel;
            desk.width = Math.max(80, initialWidth + dx);
            desk.height = Math.max(50, initialHeight + dy);
            deskEl.style.width = `${desk.width}px`;
            deskEl.style.height = `${desk.height}px`;
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function handleBoardMoveStart(e) {
        if (e.target.classList.contains('desk-resize-handle')) return;
        e.preventDefault();
        const boardEl = e.currentTarget;
        const startX = e.clientX;
        const startY = e.clientY;
        const initialX = state.board.x;
        const initialY = state.board.y;
        function onMouseMove(e) {
            const dx = (e.clientX - startX) / zoomLevel;
            const dy = (e.clientY - startY) / zoomLevel;
            state.board.x = initialX + dx;
            state.board.y = initialY + dy;
            boardEl.style.left = `${state.board.x}px`;
            boardEl.style.top = `${state.board.y}px`;
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }
    
    function handleBoardResizeStart(e) {
        e.preventDefault();
        e.stopPropagation();
        const boardEl = e.target.parentElement;
        const startX = e.clientX;
        const startY = e.clientY;
        const initialWidth = state.board.width;
        const initialHeight = state.board.height;
        function onMouseMove(e) {
            const dx = (e.clientX - startX) / zoomLevel;
            const dy = (e.clientY - startY) / zoomLevel;
            state.board.width = Math.max(100, initialWidth + dx);
            state.board.height = Math.max(20, initialHeight + dy);
            boardEl.style.width = `${state.board.width}px`;
            boardEl.style.height = `${state.board.height}px`;
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function handleDeskRotateStart(e, deskId) {
        e.preventDefault();
        e.stopPropagation();
        
        const desk = findDesk(deskId);
        const deskEl = document.getElementById(deskId);

        const rect = deskEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        const startAngleRad = Math.atan2(e.clientY - centerY, e.clientX - centerX);
        const startDeskRotation = desk.rotation || 0;

        function onMouseMove(moveEvent) {
            const currentAngleRad = Math.atan2(moveEvent.clientY - centerY, moveEvent.clientX - centerX);
            const angleDifferenceRad = currentAngleRad - startAngleRad;
            const angleDifferenceDeg = angleDifferenceRad * 180 / Math.PI;
            
            let newRotation = startDeskRotation + angleDifferenceDeg;
            if (moveEvent.shiftKey) { // Snap to 15-degree increments with Shift key
                newRotation = Math.round(newRotation / 15) * 15;
            }

            desk.rotation = newRotation;
            deskEl.style.transform = `rotate(${desk.rotation}deg)`;
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }
    
    function handleTeacherDeskMoveStart(e) {
        if(e.target.closest('.action-btn') || e.target.classList.contains('desk-resize-handle')) return;
        e.preventDefault();
        const deskEl = e.currentTarget;
        const desk = state.teacherDesk;
        const startX = e.clientX;
        const startY = e.clientY;
        const initialX = desk.x;
        const initialY = desk.y;
        function onMouseMove(e) {
            const dx = (e.clientX - startX) / zoomLevel;
            const dy = (e.clientY - startY) / zoomLevel;
            desk.x = initialX + dx;
            desk.y = initialY + dy;
            deskEl.style.left = `${desk.x}px`;
            deskEl.style.top = `${desk.y}px`;
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }
    
    function handleTeacherDeskResizeStart(e) {
        e.preventDefault();
        e.stopPropagation();
        const deskEl = e.target.parentElement;
        const desk = state.teacherDesk;
        const startX = e.clientX;
        const startY = e.clientY;
        const initialWidth = desk.width;
        const initialHeight = desk.height;
        function onMouseMove(e) {
            const dx = (e.clientX - startX) / zoomLevel;
            const dy = (e.clientY - startY) / zoomLevel;
            desk.width = Math.max(80, initialWidth + dx);
            desk.height = Math.max(50, initialHeight + dy);
            deskEl.style.width = `${desk.width}px`;
            deskEl.style.height = `${desk.height}px`;
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function handleTeacherDeskRotateStart(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const desk = state.teacherDesk;
        const deskEl = document.getElementById(desk.id);
        const rect = deskEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        const startAngleRad = Math.atan2(e.clientY - centerY, e.clientX - centerX);
        const startDeskRotation = desk.rotation || 0;

        function onMouseMove(moveEvent) {
            const currentAngleRad = Math.atan2(moveEvent.clientY - centerY, moveEvent.clientX - centerX);
            const angleDifferenceRad = currentAngleRad - startAngleRad;
            const angleDifferenceDeg = angleDifferenceRad * 180 / Math.PI;
            
            let newRotation = startDeskRotation + angleDifferenceDeg;
            if (moveEvent.shiftKey) {
                newRotation = Math.round(newRotation / 15) * 15;
            }

            desk.rotation = newRotation;
            deskEl.style.transform = `rotate(${desk.rotation}deg)`;
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            updateAllDistances();
            saveState();
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }


    // --- APP LOGIC & RULE EDITING ---
    addDeskBtn.addEventListener('click', () => {
        state.desks.push({ id: crypto.randomUUID(), x: 50, y: 50, width: 100, height: 60, capacity: 1, name: "", rotation: 0 });
        saveState();
        render();
        updateAllDistances();
    });
    
    addDeskDoubleBtn.addEventListener('click', () => {
        state.desks.push({ id: crypto.randomUUID(), x: 50, y: 50, width: 190, height: 60, capacity: 2, name: "", rotation: 0 });
        saveState();
        render();
        updateAllDistances();
    });

    function duplicateDesk(deskId) {
        const originalDesk = findDesk(deskId);
        if (!originalDesk) return;

        const newDesk = JSON.parse(JSON.stringify(originalDesk));
        newDesk.id = crypto.randomUUID();
        newDesk.x += 20;
        newDesk.y += 20;
        newDesk.rotation = originalDesk.rotation || 0;

        if (!originalDesk.name || originalDesk.name.trim() === '') {
            newDesk.name = ""; // If original has no name, new one also has no name
        } else {
            let newName;
            const nameMatch = originalDesk.name.match(/(.*[^\d])(\d+)$/);

            if (nameMatch) {
                const baseName = nameMatch[1];
                let nextNum = parseInt(nameMatch[2], 10) + 1;
                
                do {
                    newName = `${baseName}${nextNum}`;
                    nextNum++;
                } while (state.desks.some(d => d.name === newName));

            } else {
                const baseName = originalDesk.name;
                let copyIndex = 2;

                newName = `${baseName} ${copyIndex}`;
                while (state.desks.some(d => d.name === newName)) {
                    copyIndex++;
                    newName = `${baseName} ${copyIndex}`;
                }
            }
            newDesk.name = newName;
        }

        state.desks.push(newDesk);
        saveState();
        render();
        updateAllDistances();
        showNotification(`Bureau dupliqué.`);
    }

    function resetRuleForm(fullReset = false) {
        document.getElementById('editing-rule-index').value = '';
        const submitBtn = document.getElementById('rule-submit-btn');
        submitBtn.textContent = 'Ajouter Règle';
        submitBtn.classList.replace('bg-blue-500', 'bg-green-500');
        submitBtn.classList.replace('hover:bg-blue-600', 'hover:bg-green-600');
        document.getElementById('rule-cancel-btn')?.remove();

        if (fullReset) {
            addRuleForm.reset();
            ruleTypeSelect.dispatchEvent(new Event('change'));
        }
    }

    function openRuleEditor(ruleIndex) {
        const rule = state.rules[ruleIndex];
        document.getElementById('editing-rule-index').value = ruleIndex;
        document.getElementById('rule-student').value = rule.studentId || '';
        document.getElementById('rule-type').value = rule.type;
        
        ruleTypeSelect.dispatchEvent(new Event('change'));
        
        const targetStudentSelect = document.getElementById('rule-target-student');
        if (rule.targetStudentIds) {
            Array.from(targetStudentSelect.options).forEach(option => {
                option.selected = rule.targetStudentIds.includes(option.value);
            });
        }

        const submitBtn = document.getElementById('rule-submit-btn');
        submitBtn.textContent = 'Modifier Règle';
        submitBtn.classList.replace('bg-green-500', 'bg-blue-500');
        submitBtn.classList.replace('hover:bg-green-600', 'hover:bg-blue-600');

        if (!document.getElementById('rule-cancel-btn')) {
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.id = 'rule-cancel-btn';
            cancelBtn.textContent = 'Annuler';
            cancelBtn.className = 'w-full bg-gray-200 text-gray-800 py-1.5 rounded-md hover:bg-gray-300';
            cancelBtn.addEventListener('click', () => resetRuleForm(true));
            document.getElementById('rule-form-buttons').appendChild(cancelBtn);
        }
    }

    addRuleForm.addEventListener('submit', e => {
        e.preventDefault();
        const editingIndex = document.getElementById('editing-rule-index').value;
        const type = document.getElementById('rule-type').value;
        
        let newRule = { type };

        if (type !== 'MIX_GENDERS') {
            const studentId = document.getElementById('rule-student').value;
            if (!studentId) {
                showNotification("Veuillez sélectionner un élève concerné.");
                return;
            }
            newRule.studentId = studentId;

            if (!['NEAR_BOARD', 'NEAR_TEACHER_DESK', 'ISOLATED'].includes(type)) {
                const targetStudentSelect = document.getElementById('rule-target-student');
                const targetStudentIds = [...targetStudentSelect.selectedOptions].map(option => option.value);
                if (targetStudentIds.length === 0) { 
                    showNotification("Veuillez sélectionner au moins un élève cible."); 
                    return; 
                }
                if (targetStudentIds.includes(studentId)) { 
                    showNotification("Un élève ne peut pas avoir une règle avec lui-même."); 
                    return; 
                }
                newRule.targetStudentIds = targetStudentIds;
            }
        }
        
        if (editingIndex !== '') {
            state.rules[parseInt(editingIndex, 10)] = newRule;
        } else {
            // Prevent adding multiple global rules of the same type
            if (type === 'MIX_GENDERS' && state.rules.some(r => r.type === 'MIX_GENDERS')) {
                showNotification("La règle 'Mélanger les Filles et les Garçons' existe déjà.");
                return;
            }
            state.rules.push(newRule);
        }
        
        resetRuleForm(true);
        saveState();
        calculateAndStoreAllRuleScores();
        renderRules();
    });

    ruleTypeSelect.addEventListener('change', () => {
        const type = ruleTypeSelect.value;
        const isGlobalRule = type === 'MIX_GENDERS';
        const needsTarget = !['NEAR_BOARD', 'NEAR_TEACHER_DESK', 'ISOLATED', 'MIX_GENDERS'].includes(type);
        
        ruleStudentContainer.style.display = isGlobalRule ? 'none' : 'block';
        ruleTargetContainer.style.display = needsTarget ? 'block' : 'none';
    });
    
    rulesList.addEventListener('click', (e) => {
        const target = e.target.closest('.action-btn');
        if (!target) return;
        
        const ruleIndex = parseInt(target.dataset.index, 10);

        if (target.classList.contains('rule-delete-btn')) {
            showConfirmation("Voulez-vous vraiment supprimer cette règle ?", () => {
                state.rules.splice(ruleIndex, 1);
                saveState();
                calculateAndStoreAllRuleScores();
                renderRules();
            });
        } else if (target.classList.contains('rule-edit-btn')) {
            openRuleEditor(ruleIndex);
        }
    });

    // --- AUTO PLACEMENT ALGORITHM ---
    function getCenterOfStateObject(obj) {
        return { x: obj.x + obj.width / 2, y: obj.y + obj.height / 2 };
    }

    function calculateDistance(p1, p2) {
        return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
    }

    function updateAllDistances() {
        updateAllSeatDistances();
        updateTeacherDeskDistances();
        updateAllInterSeatDistances();
        updateNeighborCache();
    }

    function getAllSeatCoordinates() {
        const allSeats = [];
        state.desks.forEach(desk => {
            const deskCenterX = desk.x + desk.width / 2;
            const deskCenterY = desk.y + desk.height / 2;
            const angleRad = (desk.rotation || 0) * Math.PI / 180;
            const cosAngle = Math.cos(angleRad);
            const sinAngle = Math.sin(angleRad);

            for (let i = 0; i < desk.capacity; i++) {
                const relativeX = (desk.width * (2 * i + 1)) / (2 * desk.capacity) - (desk.width / 2);
                const relativeY = 0;
                const rotatedRelativeX = relativeX * cosAngle - relativeY * sinAngle;
                const rotatedRelativeY = relativeX * sinAngle + relativeY * cosAngle;
                const finalSeatCenterX = deskCenterX + rotatedRelativeX;
                const finalSeatCenterY = deskCenterY + rotatedRelativeY;

                allSeats.push({
                    id: `${desk.id}-${i}`,
                    deskId: desk.id,
                    center: { x: finalSeatCenterX, y: finalSeatCenterY }
                });
            }
        });
        return allSeats;
    }

    function updateAllSeatDistances() {
        if (!state.board) return;
        seatDistancesCache.clear();
        const boardCenter = getCenterOfStateObject(state.board);
        const allSeats = getAllSeatCoordinates();
        
        allSeats.forEach(seat => {
            const distance = Math.abs(seat.center.y - boardCenter.y);
            seatDistancesCache.set(seat.id, distance);
        });
        
        console.log("Distances verticales au tableau recalculées.");
        calculateAndStoreAllRuleScores();
    }
    
    function updateTeacherDeskDistances() {
        if (!state.teacherDesk) return;
        teacherDeskDistancesCache.clear();
        const teacherDeskCenter = getCenterOfStateObject(state.teacherDesk);
        const allSeats = getAllSeatCoordinates();

        allSeats.forEach(seat => {
            const distance = calculateDistance(seat.center, teacherDeskCenter);
            teacherDeskDistancesCache.set(seat.id, distance);
        });

        console.log("Distances au bureau du professeur recalculées.");
        calculateAndStoreAllRuleScores();
    }

    function updateAllInterSeatDistances() {
        interSeatDistancesCache.clear();
        const allSeats = getAllSeatCoordinates();
        for(let i = 0; i < allSeats.length; i++) {
            for(let j = i + 1; j < allSeats.length; j++) {
                const seatA = allSeats[i];
                const seatB = allSeats[j];
                const key = [seatA.id, seatB.id].sort().join('--');
                const distance = calculateDistance(seatA.center, seatB.center);
                interSeatDistancesCache.set(key, distance);
            }
        }
        console.log(`Matrice des distances entre places calculée (${interSeatDistancesCache.size} paires).`);
        calculateAndStoreAllRuleScores();
    }
    
    function calculateAndStoreAllRuleScores() {
        ruleScores.clear();
        state.rules.forEach((rule, index) => {
            let score = 0;
            if (rule.type === 'MIX_GENDERS') {
                score = scoreMixGendersRule(state.placements);
            } else {
                let studentIsPlaced = getStudentSeatId(rule.studentId, state.placements) !== null;
                if (studentIsPlaced) {
                    switch (rule.type) {
                        case 'NEAR_BOARD':
                            score = scoreNearBoardRule(rule, state.placements);
                            break;
                        case 'NEAR_TEACHER_DESK':
                            score = scoreNearTeacherDeskRule(rule, state.placements);
                            break;
                        case 'ISOLATED':
                            score = scoreIsolateRule(rule, state.placements);
                            break;
                        case 'MUST_BE_NEAR':
                            score = scoreMustBeNearRule(rule, state.placements);
                            break;
                        case 'FAR_FROM':
                            score = scoreFarFromRule(rule, state.placements);
                            break;
                        default:
                            score = 100;
                    }
                }
            }
            ruleScores.set(index, score);
        });
        updateOverallScoreDisplay();
        renderRules();
    }

    function updateOverallScoreDisplay() {
        if (state.rules.length === 0) {
            placementScoreDisplay.textContent = 'Score : N/A';
            return;
        }
        const scores = Array.from(ruleScores.values());
        const average = scores.reduce((a, b) => a + b, 0) / scores.length;
        placementScoreDisplay.textContent = `Score : ${average.toFixed(1)}%`;
    }

    function getStudentSeatId(studentId, placements) {
        for (const deskId in placements) {
            if (placements[deskId]) {
                const seatIndex = placements[deskId].indexOf(studentId);
                if (seatIndex !== -1) {
                    return `${deskId}-${seatIndex}`;
                }
            }
        }
        return null;
    }

    function scoreNearBoardRule(rule, placements) {
        const studentSeatId = getStudentSeatId(rule.studentId, placements);
        if (!studentSeatId) return 0;
        if (seatDistancesCache.size === 0) return 100;

        const distances = Array.from(seatDistancesCache.values());
        const minDistance = Math.min(...distances);
        const maxDistance = Math.max(...distances);

        if (maxDistance === minDistance) return 100;

        const studentSeatDistance = seatDistancesCache.get(studentSeatId);
        if (studentSeatDistance === undefined) return 0;
        const score = 100 * (1 - ((studentSeatDistance - minDistance) / (maxDistance - minDistance)));
        return score;
    }

    function scoreNearTeacherDeskRule(rule, placements) {
        const studentSeatId = getStudentSeatId(rule.studentId, placements);
        if (!studentSeatId) return 0;
        if (teacherDeskDistancesCache.size === 0) return 100;

        const distances = Array.from(teacherDeskDistancesCache.values());
        const minDistance = Math.min(...distances);
        const maxDistance = Math.max(...distances);

        if (maxDistance === minDistance) return 100;

        const studentSeatDistance = teacherDeskDistancesCache.get(studentSeatId);
        if (studentSeatDistance === undefined) return 0;
        const score = 100 * (1 - ((studentSeatDistance - minDistance) / (maxDistance - minDistance)));
        return score;
    }

    function scoreIsolateRule(rule, placements) {
        const studentId = rule.studentId;
        const studentSeatId = getStudentSeatId(studentId, placements);
        if (!studentSeatId) return 0;

        const [studentDeskId] = studentSeatId.split('-');
        const deskPlacement = placements[studentDeskId] || [];
        const isSharingDesk = deskPlacement.some(id => id !== null && id !== studentId);

        if (isSharingDesk) return 0;

        const allPlacedStudents = Object.values(placements).flat().filter(id => id !== null && id !== studentId);
        if (allPlacedStudents.length === 0) return 100;

        let minDistanceToNeighbor = Infinity;
        allPlacedStudents.forEach(otherStudentId => {
            const otherSeatId = getStudentSeatId(otherStudentId, placements);
            if (otherSeatId) {
                const key = [studentSeatId, otherSeatId].sort().join('--');
                const distance = interSeatDistancesCache.get(key);
                if (distance !== undefined && distance < minDistanceToNeighbor) {
                    minDistanceToNeighbor = distance;
                }
            }
        });
        
        if (minDistanceToNeighbor === Infinity) return 100;

        const allInterSeatDistances = Array.from(interSeatDistancesCache.values());
        const maxDistance = allInterSeatDistances.length > 0 ? Math.max(...allInterSeatDistances) : 0;
        if (maxDistance === 0) return 100;

        const score = 100 * (minDistanceToNeighbor / maxDistance);
        return score;
    }
    
    function scoreMixGendersRule(placements) {
        // Find all students who are currently placed
        const placedStudents = Object.values(placements).flat().filter(id => id !== null);

        if (placedStudents.length < 2) {
            return 100; // The rule cannot be violated with 0 or 1 student.
        }

        const individualScores = [];

        // Calculate a score for each placed student
        for (const studentId of placedStudents) {
            const student = findStudent(studentId);
            if (!student) continue;

            // Students with "Other" or unspecified gender get a perfect score as the rule doesn't apply to them.
            if (student.gender !== 'Garçon' && student.gender !== 'Fille') {
                individualScores.push(100);
                continue;
            }

            const neighbors = neighborCache.get(studentId);
            // If a student has no neighbors, they don't violate the mixing rule.
            if (!neighbors || neighbors.length === 0) {
                individualScores.push(100);
                continue;
            }

            // Count how many neighbors have the same gender
            let sameGenderCount = 0;
            for (const neighborId of neighbors) {
                const neighbor = findStudent(neighborId);
                if (neighbor && neighbor.gender === student.gender) {
                    sameGenderCount++;
                }
            }
            
            // The score represents the percentage of neighbors with a *different* gender.
            // 100% means perfect mixing (0 same-gender neighbors).
            // 0% means no mixing (all neighbors are the same gender).
            const score = 100 * (1 - (sameGenderCount / neighbors.length));
            individualScores.push(score);
        }

        if (individualScores.length === 0) {
            return 100; // Default to perfect score if no applicable students were found.
        }

        // The final rule score is the average of all individual student scores.
        const totalScore = individualScores.reduce((sum, score) => sum + score, 0);
        return totalScore / individualScores.length;
    }


    function scoreMustBeNearRule(rule, placements) {
        const studentSeatId = getStudentSeatId(rule.studentId, placements);
        if (!studentSeatId) return 0;
        if (!rule.targetStudentIds || rule.targetStudentIds.length === 0) return 100;

        const individualScores = rule.targetStudentIds.map(targetId => {
            const targetSeatId = getStudentSeatId(targetId, placements);
            if (!targetSeatId) return 0;

            const studentDeskId = studentSeatId.split('-')[0];
            const targetDeskId = targetSeatId.split('-')[0];
            if (studentDeskId === targetDeskId) return 100;
            
            const allOtherSeatIds = Array.from(seatDistancesCache.keys()).filter(id => id !== targetSeatId);
            if (allOtherSeatIds.length === 0) return 100;

            let maxDistance = 0;
            for (const otherSeatId of allOtherSeatIds) {
                const key = [targetSeatId, otherSeatId].sort().join('--');
                const distance = interSeatDistancesCache.get(key) || 0;
                if (distance > maxDistance) {
                    maxDistance = distance;
                }
            }
            if (maxDistance === 0) return 100;

            const key = [studentSeatId, targetSeatId].sort().join('--');
            const actualDistance = interSeatDistancesCache.get(key) || 0;
            
            return 100 * (1 - (actualDistance / maxDistance));
        });
        
        const totalScore = individualScores.reduce((sum, score) => sum + score, 0);
        return totalScore / individualScores.length;
    }
    
    function scoreFarFromRule(rule, placements) {
        const studentSeatId = getStudentSeatId(rule.studentId, placements);
        if (!studentSeatId) return 0;
        if (!rule.targetStudentIds || rule.targetStudentIds.length === 0) return 100;

        const individualScores = rule.targetStudentIds.map(targetId => {
            const targetSeatId = getStudentSeatId(targetId, placements);
            if (!targetSeatId) return 0;

            const studentDeskId = studentSeatId.split('-')[0];
            const targetDeskId = targetSeatId.split('-')[0];
            if (studentDeskId === targetDeskId) return 0;
            
            const allOtherSeatIds = Array.from(seatDistancesCache.keys()).filter(id => id !== targetSeatId);
            if (allOtherSeatIds.length === 0) return 100;

            let maxDistance = 0;
            for (const otherSeatId of allOtherSeatIds) {
                const key = [targetSeatId, otherSeatId].sort().join('--');
                const distance = interSeatDistancesCache.get(key) || 0;
                if (distance > maxDistance) {
                    maxDistance = distance;
                }
            }

            if (maxDistance === 0) return 100;

            const key = [studentSeatId, targetSeatId].sort().join('--');
            const actualDistance = interSeatDistancesCache.get(key) || 0;
            
            return 100 * (actualDistance / maxDistance);
        });

        const totalScore = individualScores.reduce((sum, score) => sum + score, 0);
        return totalScore / individualScores.length;
    }

    function calculatePlacementScore(placements) {
        if (state.rules.length === 0) return 100;

        let totalScore = 0;
        for (const rule of state.rules) {
            let ruleScore = 0;
            if (rule.type === 'MIX_GENDERS') {
                ruleScore = scoreMixGendersRule(placements);
            } else {
                let studentIsPlaced = getStudentSeatId(rule.studentId, placements) !== null;
                if (studentIsPlaced) {
                    switch (rule.type) {
                        case 'NEAR_BOARD':
                            ruleScore = scoreNearBoardRule(rule, placements);
                            break;
                        case 'NEAR_TEACHER_DESK':
                            ruleScore = scoreNearTeacherDeskRule(rule, placements);
                            break;
                        case 'ISOLATED':
                            ruleScore = scoreIsolateRule(rule, placements);
                            break;
                        case 'MUST_BE_NEAR':
                            ruleScore = scoreMustBeNearRule(rule, placements);
                            break;
                        case 'FAR_FROM':
                            ruleScore = scoreFarFromRule(rule, placements);
                            break;
                        default:
                            ruleScore = 100;
                    }
                }
            }
            totalScore += ruleScore;
        }
        return totalScore / state.rules.length;
    }

    autoPlaceBtn.addEventListener('click', () => {
        const studentsToPlaceIds = state.students.filter(s => !state.lockedStudents.includes(s.id)).map(s => s.id);
        
        const emptySeats = [];
        state.desks.forEach(desk => {
            for (let i = 0; i < desk.capacity; i++) {
                const studentIdOnSeat = state.placements[desk.id] ? state.placements[desk.id][i] : null;
                if (!studentIdOnSeat || !state.lockedStudents.includes(studentIdOnSeat)) {
                    emptySeats.push({ deskId: desk.id, seatIndex: i });
                }
            }
        });

        if (studentsToPlaceIds.length > emptySeats.length) {
            showNotification("Pas assez de places libres pour tous les élèves !");
            return;
        }

        showNotification("Recherche du meilleur placement...");
        placementScoreDisplay.textContent = 'Calcul en cours...';

        const basePlacement = JSON.parse(JSON.stringify(state.placements));
        for (const deskId in basePlacement) {
            basePlacement[deskId] = basePlacement[deskId].map(studentId => {
                return studentId && state.lockedStudents.includes(studentId) ? studentId : null;
            });
        }

        let bestPlacement = basePlacement;
        let bestScore = -1;
        let iterations = 0;
        const startTime = Date.now();

        function runSearch() {
            while (Date.now() - startTime < 5000) {
                if (bestScore === 100) break;

                const shuffledStudents = [...studentsToPlaceIds].sort(() => 0.5 - Math.random());
                const shuffledSeats = [...emptySeats].sort(() => 0.5 - Math.random());
                const currentPlacement = JSON.parse(JSON.stringify(basePlacement));
                
                shuffledStudents.forEach((studentId, i) => {
                    const seat = shuffledSeats[i];
                    if (!currentPlacement[seat.deskId]) {
                        const desk = findDesk(seat.deskId);
                        currentPlacement[seat.deskId] = Array(desk.capacity).fill(null);
                    }
                    currentPlacement[seat.deskId][seat.seatIndex] = studentId;
                });

                const currentScore = calculatePlacementScore(currentPlacement);
                if (currentScore > bestScore) {
                    bestScore = currentScore;
                    bestPlacement = currentPlacement;
                }
                iterations++;
            }

            const duration = (Date.now() - startTime) / 1000;
            state.placements = bestPlacement;
            updateNeighborCache(); // Mettre à jour le cache des voisins après le placement auto
            saveState();
            render();
            calculateAndStoreAllRuleScores();
            console.log(`Placement automatique terminé en ${duration.toFixed(2)} secondes. ${iterations} combinaisons testées.`);
            showNotification(`Meilleur placement trouvé avec un score de ${bestScore.toFixed(1)}% !`);
        }
        
        setTimeout(runSearch, 10);
    });
    
    // --- Notification System ---
    function showNotification(message) {
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        notif.className = 'bg-gray-800 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg notification';
        notif.textContent = message;
        container.appendChild(notif);
        setTimeout(() => { notif.remove(); }, 4000);
    }

    // --- Locking Students ---
    function toggleStudentLock(studentId) {
        const index = state.lockedStudents.indexOf(studentId);
        const studentName = getStudentFullName(studentId);
        if (index > -1) {
            state.lockedStudents.splice(index, 1);
            showNotification(`Le placement de ${studentName} a été déverrouillé.`);
        } else {
            state.lockedStudents.push(studentId);
            showNotification(`Le placement de ${studentName} a été verrouillé.`);
        }
        saveState();
        render();
    }
    
    // --- Import / Export ---
    exportBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify(state, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', 'plan_de_classe.json');
        linkElement.click();
    });

    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                let tempState = migrateState(JSON.parse(e.target.result));
                
                if (!tempState.settings) {
                    tempState.settings = {
                        showGenderColors: true,
                        genderColors: {
                            'Garçon': '#3b82f6', 'Fille': '#ef4444',
                            'Autre': '#eab308', '': '#fde047'
                        },
                        numberOfNeighbors: 4
                    };
                }
                 if (!tempState.teacherDesk) {
                    const defaultSingleDeskWidth = 100;
                    const defaultSingleDeskHeight = 60;
                    tempState.teacherDesk = {
                        id: 'teacher-desk', x: 1000, y: 150,
                        width: defaultSingleDeskWidth * 1.1, height: defaultSingleDeskHeight * 1.1,
                        rotation: 0, name: "Mon bureau"
                    };
                }
                if(tempState.settings.numberOfNeighbors === undefined) {
                     tempState.settings.numberOfNeighbors = 4;
                }
                tempState.students.forEach(s => {
                    if (s.gender === undefined) {
                        s.gender = '';
                    }
                });

                if (tempState.students && tempState.desks) {
                    state = tempState;
                    toggleGenderColors.checked = state.settings.showGenderColors;
                    saveState();
                    render();
                    updateStudentsInForms();
                    updateAllDistances();
                    showNotification('Données importées avec succès !');
                } else { showNotification('Fichier JSON invalide.'); }
            } catch (error) {
                console.error("Erreur d'importation:", error);
                showNotification('Erreur lors de la lecture du fichier.');
            }
        };
        reader.readAsText(file);
        importFileInput.value = '';
    });

    // --- Customization ---
    function openCustomizationModal() {
        document.getElementById('color-boy').value = state.settings.genderColors['Garçon'];
        document.getElementById('color-girl').value = state.settings.genderColors['Fille'];
        document.getElementById('color-other').value = state.settings.genderColors['Autre'];
        document.getElementById('color-unspecified').value = state.settings.genderColors[''];
        
        const neighborInput = document.getElementById('neighbor-count');
        neighborInput.value = state.settings.numberOfNeighbors;
        neighborInput.max = Math.max(0, state.students.length - 1);

        customizationModal.classList.remove('hidden');
    }

    function closeCustomizationModal() {
        customizationModal.classList.add('hidden');
    }

    customizationBtn.addEventListener('click', openCustomizationModal);
    closeCustomizationModalBtn.addEventListener('click', closeCustomizationModal);
    customizationModal.addEventListener('click', e => {
        if (e.target === customizationModal) {
            closeCustomizationModal();
        }
    });

    customizationForm.addEventListener('submit', e => {
        e.preventDefault();
        state.settings.genderColors['Garçon'] = document.getElementById('color-boy').value;
        state.settings.genderColors['Fille'] = document.getElementById('color-girl').value;
        state.settings.genderColors['Autre'] = document.getElementById('color-other').value;
        state.settings.genderColors[''] = document.getElementById('color-unspecified').value;
        
        const neighborCount = parseInt(document.getElementById('neighbor-count').value, 10);
        const maxNeighbors = Math.max(0, state.students.length - 1);
        state.settings.numberOfNeighbors = Math.max(0, Math.min(neighborCount, maxNeighbors));

        updateNeighborCache();
        saveState();
        render();
        closeCustomizationModal();
        showNotification('Paramètres sauvegardés !');
    });

    resetColorsBtn.addEventListener('click', () => {
        const defaultColors = {
            'Garçon': '#3b82f6',
            'Fille': '#ef4444',
            'Autre': '#eab308',
            '': '#fde047'
        };
        state.settings.genderColors = defaultColors;
        openCustomizationModal(); // Re-populate inputs with default values
    });

    toggleGenderColors.addEventListener('change', () => {
        state.settings.showGenderColors = toggleGenderColors.checked;
        saveState();
        render();
    });
    
    // --- Neighbor Logic ---
    function updateNeighborCache() {
        neighborCache.clear();
        const placedStudents = state.students.filter(s => getStudentSeatId(s.id, state.placements));

        placedStudents.forEach(studentA => {
            const studentASeatId = getStudentSeatId(studentA.id, state.placements);
            const distances = [];

            placedStudents.forEach(studentB => {
                if (studentA.id === studentB.id) return;

                const studentBSeatId = getStudentSeatId(studentB.id, state.placements);
                const key = [studentASeatId, studentBSeatId].sort().join('--');
                const distance = interSeatDistancesCache.get(key);
                if (distance !== undefined) {
                    distances.push({ studentId: studentB.id, distance });
                }
            });

            distances.sort((a, b) => a.distance - b.distance);
            const neighbors = distances.slice(0, state.settings.numberOfNeighbors).map(d => d.studentId);
            neighborCache.set(studentA.id, neighbors);
        });
        console.log("Cache des voisins mis à jour.");
    }


    // --- INITIALIZATION ---
    function init() {
        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', () => {
                sidebarWrapper.classList.toggle('collapsed');
            });
        }
        classroomContent.addEventListener('click', e => {
            const studentEl = e.target.closest('.student-container');
            if (studentEl) {
                const studentId = studentEl.dataset.studentId;
                if (selectedStudentId === studentId) {
                    selectedStudentId = null; // Deselect if clicking the same student
                } else {
                    selectedStudentId = studentId;
                }
            } else if (!e.target.closest('.desk-container')) {
                 selectedStudentId = null;
                 if (selectedDeskIds.size > 0) {
                     selectedDeskIds.clear();
                 }
            }
            render();
        });

        classroomArea.addEventListener('mousedown', e => {
            if (e.target.closest('.student-container')) return;

            if (e.target !== classroomArea && e.target !== classroomContent) {
                if (!e.target.closest('.desk-container')) {
                    if (selectedDeskIds.size > 0) {
                        selectedDeskIds.clear();
                        updateSelectionVisuals();
                    }
                }
                return;
            }
            
            if(e.ctrlKey) return;
            
            e.preventDefault();

            const rect = classroomContent.getBoundingClientRect();
            const startX = (e.clientX - rect.left) / zoomLevel;
            const startY = (e.clientY - rect.top) / zoomLevel;

            const selectionRectEl = document.createElement('div');
            selectionRectEl.className = 'selection-rectangle';
            classroomContent.appendChild(selectionRectEl);

            function onMouseMove(moveEvent) {
                const currentX = (moveEvent.clientX - rect.left) / zoomLevel;
                const currentY = (moveEvent.clientY - rect.top) / zoomLevel;
                
                const x = Math.min(startX, currentX);
                const y = Math.min(startY, currentY);
                const width = Math.abs(startX - currentX);
                const height = Math.abs(startY - currentY);

                selectionRectEl.style.left = `${x}px`;
                selectionRectEl.style.top = `${y}px`;
                selectionRectEl.style.width = `${width}px`;
                selectionRectEl.style.height = `${height}px`;

                const selectionRect = { x1: x, y1: y, x2: x + width, y2: y + height };

                selectedDeskIds.clear(); // Clear selection at the beginning of each move
                state.desks.forEach(desk => {
                    const deskRect = {
                        x1: desk.x,
                        y1: desk.y,
                        x2: desk.x + desk.width,
                        y2: desk.y + desk.height
                    };

                    if (selectionRect.x1 < deskRect.x2 &&
                        selectionRect.x2 > deskRect.x1 &&
                        selectionRect.y1 < deskRect.y2 &&
                        selectionRect.y2 > deskRect.y1)
                    {
                        selectedDeskIds.add(desk.id);
                    }
                });
                updateSelectionVisuals();
            }

            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                if (selectionRectEl) {
                    selectionRectEl.remove();
                }
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        console.log("Tentative de lecture des données depuis le localStorage...");
        const savedState = localStorage.getItem('classroomPlanState');
        if (savedState) {
            console.log("Données trouvées dans le localStorage, chargement...");
            let tempState = migrateState(JSON.parse(savedState));
            // Ensure all new top-level state properties exist
            if (!tempState.teacherDesk) {
                const defaultSingleDeskWidth = 100;
                const defaultSingleDeskHeight = 60;
                tempState.teacherDesk = {
                    id: 'teacher-desk', x: 1000, y: 150,
                    width: defaultSingleDeskWidth * 1.1, height: defaultSingleDeskHeight * 1.1,
                    rotation: 0, name: "Mon bureau"
                };
            }
            if (!tempState.settings) {
                tempState.settings = {
                    showGenderColors: true,
                    genderColors: {
                        'Garçon': '#3b82f6', 'Fille': '#ef4444',
                        'Autre': '#eab308', '': '#fde047'
                    },
                    numberOfNeighbors: 4
                };
            }
            if(tempState.settings.numberOfNeighbors === undefined) {
                 tempState.settings.numberOfNeighbors = 4;
            }
            tempState.students.forEach(s => {
                if (s.gender === undefined) s.gender = '';
            });
            state = tempState;

        } else {
            console.log("Aucune donnée trouvée, création d'une classe par défaut.");
            const hermione = { id: crypto.randomUUID(), firstName: 'Hermione', lastName: 'Granger', gender: 'Fille' };
            const harry = { id: crypto.randomUUID(), firstName: 'Harry', lastName: 'Potter', gender: 'Garçon' };
            state.students.push(hermione, harry);

            state.rules.push({ studentId: hermione.id, type: 'NEAR_BOARD', targetStudentIds: [] });
            
            const deskWidth = 190;
            const horizontalSpacing = 40;
            const numCols = 4;
            const totalWidthOfDesks = (numCols * deskWidth) + ((numCols - 1) * horizontalSpacing); // 760 + 120 = 880
            const startX = 50;
            
            const defaultBoardWidth = 190 * 4; // 760
            const boardX = startX + (totalWidthOfDesks / 2) - (defaultBoardWidth / 2); // 50 + 440 - 380 = 110

            state.board = { x: boardX, y: 20, width: defaultBoardWidth, height: 20 };
            
            const deskHeight = 60;
            const verticalSpacing = 50;
            const numRows = 3;
            const startY = 150; // Increased to avoid overlap with unplaced students
            for (let row = 0; row < numRows; row++) {
                for (let col = 0; col < numCols; col++) {
                    const newDesk = { id: crypto.randomUUID(), x: startX + col * (deskWidth + horizontalSpacing), y: startY + row * (deskHeight + verticalSpacing), width: deskWidth, height: deskHeight, capacity: 2, name: ``, rotation: 0 };
                    state.desks.push(newDesk);
                }
            }

            const defaultSingleDeskWidth = 100;
            const defaultSingleDeskHeight = 60;
            state.teacherDesk = {
                id: 'teacher-desk',
                x: startX + totalWidthOfDesks + 50, y: startY,
                width: defaultSingleDeskWidth * 1.1,
                height: defaultSingleDeskHeight * 1.1,
                rotation: 0, name: "Mon bureau"
            };

            saveState();
        }

        toggleGenderColors.checked = state.settings.showGenderColors;

        updateAllDistances();
        render();
        updateStudentsInForms();
        
        document.getElementById('rule-type').value = 'NEAR_BOARD';
        ruleTypeSelect.dispatchEvent(new Event('change'));
    }

    // --- Zoom Logic ---
    function updateZoom() {
        classroomContent.style.transform = `scale(${zoomLevel})`;
        zoomDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
    }
    zoomInBtn.addEventListener('click', () => {
        zoomLevel = Math.min(2, zoomLevel + 0.1);
        updateZoom();
    });
    zoomOutBtn.addEventListener('click', () => {
        zoomLevel = Math.max(0.25, zoomLevel - 0.1);
        updateZoom();
    });
    zoomResetBtn.addEventListener('click', () => {
        zoomLevel = 1.0;
        updateZoom();
    });

    init();
});
</script>

</body>
</html>


